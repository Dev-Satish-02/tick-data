<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Candlestick Chart from CSV</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    #chart {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="chart"></div>

  <script>
    function splitData(rawData) {
      const categoryData = [];
      const values = [];

      rawData.forEach(item => {
        categoryData.push(item[0]);  // Date
        values.push(item.slice(1));  // [open, close, low, high]
      });

      return {
        categoryData: categoryData,
        values: values
      };
    }

    function parseCsvAndConvertToEcharts(csvText) {
      const parsed = Papa.parse(csvText, { header: true });
      const data = parsed.data;

      return data
        .filter(row => row.minute) // skip empty rows
        .map(row => {
          const rawDate = row.minute; // e.g. "20250728_1212"
          const dateFormatted = `${rawDate.slice(0, 4)}/${rawDate.slice(4, 6)}/${rawDate.slice(6, 8)}`;

          return [
            dateFormatted,
            parseFloat(row.open),
            parseFloat(row.close),
            parseFloat(row.low),
            parseFloat(row.high)
          ];
        });
    }

    function renderChart(data0) {
      const chartDom = document.getElementById('chart');
      const myChart = echarts.init(chartDom);

      const option = {
        title: {
          text: 'Candlestick Chart from CSV',
          left: 0
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'cross'
          }
        },
        xAxis: {
          type: 'category',
          data: data0.categoryData,
          scale: true,
          boundaryGap: false,
          axisLine: { onZero: false },
          splitLine: { show: false },
          min: 'dataMin',
          max: 'dataMax'
        },
        yAxis: {
          scale: true,
          splitArea: {
            show: true
          }
        },
        series: [
          {
            type: 'candlestick',
            data: data0.values,
            itemStyle: {
              color: '#ec0000',
              color0: '#00da3c',
              borderColor: '#8A0000',
              borderColor0: '#008F28'
            }
          }
        ]
      };

      myChart.setOption(option);
    }

    // Load and process the CSV
    fetch('summary.csv')
      .then(response => response.text())
      .then(csvText => {
        const formattedData = parseCsvAndConvertToEcharts(csvText);
        const data0 = splitData(formattedData);
        renderChart(data0);
      })
      .catch(error => {
        console.error('Error loading CSV:', error);
      });
  </script>
</body>
</html>
